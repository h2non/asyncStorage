/*! asyncStore - v0.1.0 - MIT License - https://github.com/h2non/asyncStore */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.asyncStore=e()}}(function(){var define,module,exports;return function e(t,n,r){function i(o,a){if(!n[o]){if(!t[o]){var u=typeof require=="function"&&require;if(!a&&u)return u(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return i(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<r.length;o++)i(r[o]);return i}({1:[function(e,t,n){var r=e("./utils");var i=e("./worker");var s=window.addEventListener?"addEventListener":"attachEvent";var o=s==="attachEvent"?"onmessage":"message";var a=window[s];var u=window[window.removeEventListener?"removeEventListener":"detachEvent"];t.exports=c;function c(e){this.id=e;this._terminated=false;this.listeners={};this._create();this._setupListeners();this._initialize()}c.prototype._create=function(){var e=this.iframe=document.createElement("iframe");if(!e.style)e.style={};e.style.display="none";e.id="thread-"+this.id;document.body.appendChild(e)};c.prototype._subscribeListeners=function(e){var t=this.listeners;if(s==="attachEvent")e="on"+e;function n(n){if(n.data&&n.data.owner==="thread.js"){if(t[e]){r.each(t[e],function(e){if(r.isFn(e))e(n)})}}}this._eventHandler=n;a(e,n)};c.prototype._setupListeners=function(){this._subscribeListeners("message");this._subscribeListeners("error")};c.prototype._unsubscribeListeners=function(){u("error",this._eventHandler);u("message",this._eventHandler)};c.prototype._getWindow=function(){var e=null;if(!this._terminated){e=this.iframe.contentWindow;var t=e.eval;if(!t&&e.execScript){e.execScript("null");t=e.eval}}return e};c.prototype._initialize=function(e){var t=this._getWindow();if(t)t.eval.call(t,r.getSource(i))};c.prototype.addEventListener=function(e,t){var n=this.listeners[e]=this.listeners[e]||[];if(r.isFn(t))n.push(t)};c.prototype.removeEventListener=function(e,t){var n,i=this.listeners[e];if(i){if(r.isFn(t)){i.splice(0,i.length)}else{n=i.indexOf(t);if(n>=0)i.splice(n,1)}}};c.prototype.postMessage=function(e){var t=this._getWindow();if(t){e.origin=r.getLocation();t.postMessage(e,e.origin)}};c.prototype.terminate=function(){this.listeners={};this._terminated=true;this._unsubscribeListeners();document.body.removeChild(this.iframe)}},{"./utils":7,"./worker":8}],2:[function(e,t,n){var r=e("./store");var i=e("./thread");t.exports=s;window.thread=window.thread||s;function s(e){return new i(e)}s.VERSION="0.1.15";s.create=s;s.Task=i.Task;s.Thread=i;s.total=r.all;s.total=r.total;s.running=r.running;s.idle=r.idle;s.flush=r.flush;s.killAll=s.terminateAll=r.killAll;s.killIdle=s.terminateIdle=r.killIdle},{"./store":4,"./thread":6}],3:[function(e,t,n){var r=e("./utils");t.exports=i;function i(e,t){var n=t.run;var s=[t];var o=t.options;var a=t.terminate;function u(e){var t,n,r,i;for(t=0,n=s.length;t<n;t+=1){r=s[t];i=r.pending();if(i===0||i<e){if(r.terminated){s.splice(t,1);n-=1}else{return r}}}}function c(){var e=new i.Thread(o);s.push(e);return e}function l(e,t){var r;if(e===s[0]){r=n.apply(e,t)}else{r=e.run.apply(e,t)}return r}t.run=t.exec=function(){var t=arguments;function n(r){var i,o=u(r);if(o){i=l(o,t)}else{if(s.length<e){i=l(c(),t)}else{i=n(r+1)}}return i}return n(0)};t.terminate=t.kill=function(){r.each(s,function(e,t){if(t===0)a.call(e);else e.terminate()});s.splice(0)};t.threadPool=s;t.isPool=true;return t}},{"./utils":7}],4:[function(e,t,n){var r=e("./utils");var i=[];var s=t.exports={};s.push=function(e){i.push(e)};s.all=function(){return i.slice()};s.remove=function(e){var t=i.indexOf(e);if(t>=0)i.splice(t,1)};s.flush=function(){i.splice(0)};s.total=function(){return i.length};function o(e){var t=[];r.each(i,function(n){if(n[e]())t.push(n)});return t}s.running=function(){return o("running")};s.idle=function(){return o("idle")};s.killAll=function(){var e=i.slice();r.each(e,function(e){e.kill()})};s.killIdle=function(){r.each(s.idle(),function(e){e.kill()})}},{"./utils":7}],5:[function(e,t,n){var r=e("./utils");t.exports=i;function i(e,t){this.id=r.uuid();this.thread=e;this.worker=e.worker;this.env=t||{};this.time=this.memoized=null;this.listeners={error:[],success:[],end:[]}}i.intervalCheckTime=200;i.prototype.bind=i.prototype.set=function(e){r.extend(this.env,e);return this};i.prototype.run=i.prototype.exec=function(e,t,n){var u=this.thread;if(!u||u._terminated){throw new Error("cannot execute the task. The thread was terminated")}if(!r.isFn(e)){throw new TypeError("first argument must be a function")}if(r.isArr(arguments[1]))n=arguments[1];if(r.isObj(arguments[2]))t=arguments[2];t=r.serializeMap(r.extend({},this.env,t));this.memoized=null;this.time=r.now();if(u.maxTaskDelay>=i.intervalCheckTime){o(this,u.maxTaskDelay)}if(u._tasks.indexOf(this)===-1){u._tasks.push(this)}this["finally"](p(u,this));a(this);s(this,t,e,n);return this};i.prototype.then=i.prototype.success=function(e,t){if(r.isFn(e))u(this,"success",e);if(r.isFn(t))this["catch"](t);return this};i.prototype["catch"]=i.prototype.error=function(e){if(r.isFn(e))u(this,"error",e);return this};i.prototype["finally"]=i.prototype.finish=function(e){if(r.isFn(e)){if(this.memoized)e.call(null,g(this.memoized));else this.listeners.end.push(e)}return this};i.prototype.flush=function(){this.memoized=this.thread=null;this.worker=this.env=this.listeners=null};i.prototype.flushed=function(){return!this.thread&&!this.worker};i.create=function(e){return new i(e)};function s(e,t,n,r){e.worker.postMessage({id:e.id,type:"run",env:t,src:n.toString(),args:r})}function o(e,t){var n=r.now();e._timer=setInterval(function(){if(e.memoized){h.call(e)}else{d.call(e,n,t)}},i.intervalCheckTime)}function a(e){e.worker.addEventListener("message",m(e))}function u(e,t,n){if(e.memoized){if(e.memoized.type==="run:"+t)n.call(null,g(e.memoized))}else{e.listeners[t].push(n)}}function c(e,t,n){if(typeof e._timer==="number")h.call(e);l(e,t)(e.listeners[n])}function l(e,t){return function n(e){var i=null;if(r.isArr(e)){i=e.shift();if(i){i.call(null,t);if(e.length)n(e)}}}}function f(e){var t=new Error(e.error);t.name=e.errorName;t.stack=e.errorStack;return t}function p(e,t){return function(){var n=e._tasks.indexOf(t);e._latestTask=r.now();if(n>=0)e._tasks.splice(n,1)}}function d(e,t){var n=null;if(r.now()-e>t){n=new Error("maximum task execution time exceeded");this.memoized={type:"run:error",error:n};c(this,n,"error");c(this,n,"end");h.call(this)}}function h(){clearInterval(this._timer);this._timer=null}function v(e){return e==="run:error"||e==="run:success"}function m(e){return function t(n){var r=n.data;if(r&&r.id===e.id&&v(r.type)){e.worker.removeEventListener("message",t);e.memoized=r;y(e,r)}}}function y(e,t){var n=g(t);c(e,n,t.type.split(":")[1]);c(e,n,"end")}function g(e){return e.type==="run:error"?f(e):e.value}},{"./utils":7}],6:[function(e,t,n){var r=e("./utils");var i=e("./worker");var s=e("./task");var o=e("./fake-worker");var a=e("./pool");var u=e("./store");var c=window.Worker;var l=window.URL||window.webkitURL;var f=r.isFn(c)||c&&typeof c==="object"||false;var p=/MSIE (10|11)/.test(window.navigator.userAgent);var d=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;t.exports=h;function h(e){this.id=r.uuid();this.terminated=false;this.options={};this._tasks=[];this._latestTask=0;v(this,e);m(this)}h.prototype.isPool=false;h.prototype.maxTaskDelay=0;h.prototype.idleTime=30*1e3;h.prototype.defaults={evalPath:"lib/eval.js",silent:false};h.prototype.run=h.prototype.exec=function(e,t,n){var i;if(r.isArr(t)){n=t;t=arguments[2]}if(e&&e instanceof s){i=e}else{if(!r.isFn(e))throw new TypeError("first argument must be a function");i=new s(this)}this._tasks.push(i);r.defer(function(){i.run(e,t,n)});return i};h.prototype.require=h.prototype["import"]=function(e,t){if(r.isFn(e)){t=e;e=r.fnName(t);if(!e)throw new Error("function must be named");this.send({type:"require:fn",src:t.toString(),name:r.fnName(t)})}else if(typeof e==="string"){if(r.isFn(t)){this.send({type:"require:fn",src:t.toString(),name:e})}else{if(r.isArr(this.options.require))this.options.require.push(e);this.send({type:"require:file",src:e})}}else if(r.isArr(e)){if(r.isArr(this.options.require))this.options.require=this.options.require.concat(e);this.send({type:"require:file",src:e})}else if(r.isObj(e)){this.send({type:"require:map",src:r.serializeMap(e)})}return this};h.prototype.bind=h.prototype.set=function(e){this.send({type:"env",data:r.serializeMap(e)});return this};h.prototype.flush=function(){this.send({type:"flush"});this.options.env={};return this};h.prototype.flushTasks=function(){r.each(this.tasks,function(e){e.flush()});this._tasks.splice(0);return this};h.prototype.send=function(e){if(this.worker){this.worker.postMessage(e)}};h.prototype.pool=function(e){return a(e||2,this)};h.prototype.terminate=h.prototype.kill=function(){if(!this.terminated){this.options={};this.flushTasks().flush();this.terminated=true;this.worker.terminate();u.remove(this)}return this};h.prototype.start=h.prototype.init=function(e){if(this.terminated){this._setOptions(e);this._create();this.terminated=false}return this};h.prototype.pending=function(){return this._tasks.length};h.prototype.running=function(){return this._tasks.length>0};h.prototype.idle=h.prototype.sleep=function(){return!this.running()&&!this.terminated&&(this._latestTask===0||r.now()-this._latestTask>this.idleTime)};h.prototype.on=h.prototype.addEventListener=function(e,t){if(this.worker)this.worker.addEventListener(e,t);return this};h.prototype.off=h.prototype.removeEventListener=function(e,t){if(this.worker&&r.isFn(t)){this.worker.removeEventListener(e,t)}return this};h.prototype.toString=function(){return"[object Thread]"};a.Thread=h;h.Task=s;function v(e,t){e.options.namespace="env";e.options.require=[];e.options.env={};r.extend(e.options,e.defaults,t)}function m(e){var t=r.getSource(i);if(f&&l){if(p){e.worker=new c(e.options.evalPath);e.worker.postMessage(t)}else{e.worker=new c(y(t))}}else{e.worker=new o(e.id)}if(!e.options.silent){e.worker.addEventListener("error",function(e){throw e})}e.send({type:"start",env:r.serializeMap(e.options.env),namespace:e.options.namespace,origin:r.getLocation()});e.require(e.options.require);u.push(e)}function y(e){var t=null;try{t=new Blob([e],{type:"text/javascript"})}catch(n){t=new d;t.append(e);t=t.getBlob()}return l.createObjectURL(t)}},{"./fake-worker":1,"./pool":3,"./store":4,"./task":5,"./utils":7,"./worker":8}],7:[function(e,t,n){var r=n;var i=Object.prototype.toString;var s=Array.prototype.slice;var o=Object.prototype.hasOwnProperty;var a=Array.isArray;r.now=function(){return(new Date).getTime()};r.isFn=function(e){return typeof e==="function"};r.isObj=function(e){return e&&i.call(e)==="[object Object]"||false};r.isArr=function(e){return e&&(a?a(e):i.call(e)==="[object Array]")||false};r.toArr=function(e){return s.call(e)};r.defer=function(e){setTimeout(e,1)};r.each=function(e,t){var n,i;if(r.isArr(e))for(n=0,i=e.length;n<i;n+=1)t(e[n],n);else if(r.isObj(e))for(n in e)if(o.call(e,n))t(e[n],n)};r.extend=function(e){var t=r.toArr(arguments).slice(1);r.each(t,function(t){if(r.isObj(t)){r.each(t,function(t,n){e[n]=t})}});return e};r.getSource=function(e){return"("+e.toString()+").call(this)"};r.fnName=function(e){return e.name||(e=/\W*function\s+([\w\$]+)\(/.exec(e.toString())?e[1]:"")};r.serializeMap=function(e){if(r.isObj(e)){r.each(e,function(t,n){if(r.isFn(t)){e["$$fn$$"+n]=t.toString();e[n]=undefined}})}return e};r.uuid=function(){var e="",t,n;for(t=0;t<32;t++){n=Math.random()*16|0;if(t===8||t===12||t===16||t===20)e+="-";e+=(t===12?4:t===16?n&3|8:n).toString(16)}return e};r.getLocation=function(){return location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}},{}],8:[function(require,module,exports){module.exports=worker;function worker(){var self=this;function $$evalExpr(expr){var fn=null;eval("fn = "+expr);return fn}(function isolated(){"use strict";var namespace="env";var isWorker=typeof document==="undefined";var toStr=Object.prototype.toString;var slice=Array.prototype.slice;var eventMethod=self.addEventListener?"addEventListener":"attachEvent";var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";var importFn=isWorker?importScripts:appendScripts;var ready=false;var fnRegex=/^\$\$fn\$\$/;var urlProtocolRegex=/^http[s]?/;var isArrayNative=Array.isArray;var queue,origin,scriptsLoad,intervalId=null;self.addEventListener=self[eventMethod];if(typeof window==="undefined"){self.window=self}function isObj(e){return e&&toStr.call(e)==="[object Object]"}function isArr(e){return e&&(isArrayNative?isArrayNative(e):toStr.call(e)==="[object Array]")||false}function mapFields(e){for(var t in e)if(e.hasOwnProperty(t)){if(fnRegex.test(t)){e[t.replace("$$fn$$","")]=$$evalExpr(e[t]);e[t]=undefined}else{e[t]=e[t]}}return e}function extend(e,t){var n,r,i,s=slice.call(arguments).slice(1);for(n=0,r=s.length;n<r;n+=1){t=s[n];if(isObj(t)){t=mapFields(t);for(i in t)if(t[i]!==undefined){e[i]=t[i]}}}return e}function each(e,t){var n,r;if(isArr(e)){if(e.forEach){e.forEach(t)}else{for(n=0,r=e.length;n<r;n+=1){t(e[n],n)}}}else if(isObj(e)){for(n in e)if(e.hasOwnProperty(n)){t(e[n],n)}}}function waitToDocumentReady(){if(document.readyState==="complete"){ready=true}else{document.onreadystatechange=function(){if(document.readyState==="complete"){ready=true}}}}function appendScript(e){var t=document.getElementsByTagName("head")[0];var n=document.createElement("script");n.type="text/javascript";n.src=e;scriptsLoad.push(n);n.onload=n.onreadystatechange=function(){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){scriptsLoad.splice(scriptsLoad.indexOf(n),1)}n.onload=n.onreadystatechange=null};t.appendChild(n)}function appendScripts(){var e,t,n=slice.call(arguments);for(e=0,t=n.length;e<t;e+=1){if(n[e])appendScript(n[e])}}function scriptsLoadTimer(){intervalId=setInterval(function(){if(ready&&!scriptsLoad.length){clearInterval(intervalId);each(queue,function(e){e()});queue=[];intervalId=null}},50)}function loadScripts(e){if(isArr(e)){importFn.apply(self,e.map(makePathFullUrl))}else{importFn(makePathFullUrl(e))}if(!isWorker&&!intervalId){scriptsLoadTimer()}}function makePathFullUrl(e){if(urlProtocolRegex.test(e)===false){e=origin+e}return e}function require(e){if(isArr(e)||typeof e==="string"){loadScripts(e)}else if(isObj(e)){each(e,function(e,t){requireFn(t,e)})}}function requireFn(name,fn){if(fnRegex.test(name)){name=name.replace("$$fn$$","");fn=$$evalExpr(fn)}eval("self[namespace][name] = "+fn)}function postMessage(e){if(isWorker){self.postMessage(e)}else{e.owner="thread.js";self.parent.postMessage(e,origin)}}function sendError(e,t){postMessage({type:"run:error",id:e.id,error:t.message||t,errorName:t.name||null,errorStack:t.stack||null})}function sendSuccess(e,t){postMessage({type:"run:success",id:e.id,value:t})}function done(e){return function(t,n){if(t){sendError(e,t)}else{sendSuccess(e,n)}}}function process(e){var t=null;var n=e.args||[];var r=$$evalExpr(e.src);var i=isObj(e.env)?mapFields(e.env):self[namespace];if(r.length===n.length+1){n.push(done(e));r.apply(i,n)}else{t=r.apply(i,n);if(t instanceof Error){sendError(e,t)}else{sendSuccess(e,t)}}}function run(e){function t(){try{process(e)}catch(t){sendError(e,t)}}if(!isWorker&&(!ready||scriptsLoad.length)){queue.push(t)}else{t()}}function start(e){if(e.require){require(e.require)}if(e.origin){origin=e.origin}namespace=e.namespace||namespace;self[namespace]=mapFields(e.env||{})}function flush(){self[namespace]={}}function extendEnv(e){extend(self[namespace||namespace],e.env)}function onMessage(e){var t=e.data;if(t.origin){origin=t.origin}switch(t.type){case"start":start(t);break;case"run":run(t);break;case"env":extendEnv(t);break;case"require:fn":requireFn(t.name,t.src);break;case"require:file":case"require:map":require(t.src);break;case"flush":flush();break}}if(!isWorker){scriptsLoad=[];queue=[];waitToDocumentReady()}self.addEventListener(messageEvent,onMessage);self.addEventListener("error",function(e){throw e})})()}},{}],9:[function(e,t,n){"use strict";var r=e("thread-js");var i=t.exports=window.asyncStore=window.asyncStorage=Object.create(s.prototype);s.call(i);function s(){s.run=l(this)}s.prototype.constructor=s;s.prototype.getItem=function(e,t){s.run("get",e,null,t)};s.prototype.setItem=function(e,t,n){n=o(a(this),n);s.run("add",e,t,n)};s.prototype.removeItem=function(e,t){t=o(crecementLength(this),t);s.run("delete",e,null,t)};s.prototype.clear=function(e){s.run("clear",null,null,e)};s.prototype.length=0;function o(e,t){return function(n,r){if(!n)e();t(n,r)}}function a(e){return function(){e.length+=1}}function u(e){return function(){e.length-=1}}function c(e){var t=null;return function n(){if(t===null){t=r({evalPath:e.evalPath,require:"https://cdn.rawgit.com/dfahlander/Dexie.js/master/dist/latest/Dexie.js"})}return t}}function l(e){var t=c(e);return function(){var e=f(arguments);var n=e.pop()||p;t().run(function(e,t,n,r){var i=[].slice(arguments).slice(1);var s=self.db;if(!s){self.db=s=new Dexie("asyncStorage");s.version(1).stores({pairs:"++id, key, value"})}s.open().then(function(){s.transaction("rw",s.pairs,o).catch(r)}).catch(r);function o(){switch(e){case"get":s.pairs.where("key").equals(t).first().then(function(e){r(null,e.value)}).catch(r);break;case"add":s.pairs.add({key:t,value:n}).then(function(){r()}).catch(r);break;case"delete":s.pairs.where("key").equals(t).delete().then(function(){r()}).catch(r);break;case"clear":s.delete().then(function(){r()}).catch(r);break;throw new Error}}},e.slice(3)).then(n).catch(n)}}function f(e){var t=new Array(e.length);for(var n=0,r=e.length;n<r;n+=1){t[n]=e[n]}return t}function p(){}},{"thread-js":2}]},{},[9])(9)});
//# sourceMappingURL=http://cdn.rawgit.com/h2non/asyncStore/0.1.0/asyncStore.min.js.map